<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Stats Parser v.7.0</title>
    <style>
        :root { --primary: #10b981; --bg: #0b0e14; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #e2e8f0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: #161b22; padding: 30px; border-radius: 20px; border: 1px solid #30363d; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 600px; width: 100%; text-align: center; }
        h1 { color: var(--primary); margin-bottom: 5px; }
        .badge { background: #7c3aed; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .api-container { margin: 15px 0; text-align: left; }
        input[type="password"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: #7dd3fc; text-align: center; margin-top: 5px; box-sizing: border-box; }
        .upload-box { border: 2px dashed #30363d; padding: 40px 20px; border-radius: 15px; cursor: pointer; margin: 20px 0; transition: 0.3s; }
        .upload-box:hover { border-color: var(--primary); background: #0d1117; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 10px; width: 100%; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn:disabled { background: #30363d; cursor: not-allowed; }
        #log { margin-top: 20px; text-align: left; font-size: 11px; background: #000; color: #34d399; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; display: none; border: 1px solid #30363d; }
    </style>
</head>
<body>

<div class="card">
    <h1>Golf Stats Parser v.7.0</h1>
    <div style="margin-bottom: 15px;">
        <span class="badge">Multi-Type Detection</span>
        <span class="badge" style="background:#2563eb">Fuzzy Name Match</span>
    </div>
    
    <div class="api-container">
        <input type="password" id="apiKey" placeholder="Vloûte Groq API kæ˙Ë">
    </div>

    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        <strong>NAHRAç OBR¡ZKY (aj 100+)</strong>
        <div id="fileInfo" style="margin-top:10px; color: #8b949e;"></div>
    </div>

    <button id="runBtn" class="btn" onclick="startProcess()">SPRACOVAç ⁄DAJE</button>
    <div id="log"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('log');
    const apiKeyInput = document.getElementById('apiKey');

    // Predvolen· ötrukt˙ra hr·Ëa (vöetky hodnoty 0)
    const defaultStats = () => ({
        longest_drive: 0,
        score_avg: 0,
        par_3: 0,
        par_4: 0,
        par_5: 0,
        aces: 0,
        d_eagles: 0,
        eagles: 0,
        birdies: 0,
        pars: 0,
        bogeys: 0,
        d_bogeys: 0,
        found: false // len pomocn· premenn·
    });

    window.onload = () => {
        const savedKey = localStorage.getItem('groq_api_key');
        if (savedKey) apiKeyInput.value = savedKey;
    };

    fileInput.onchange = () => {
        document.getElementById('fileInfo').innerText = `Vybran˝ch s˙borov: ${fileInput.files.length}`;
    };

    function addLog(msg) {
        logDiv.style.display = 'block';
        const d = document.createElement('div');
        d.innerText = `> ${msg}`;
        logDiv.appendChild(d);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Levenshteinova vzdialenosù pre porovn·vanie mien (Fuzzy Matching)
    function levenshtein(a, b) {
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    // N·jde podobnÈ meno v mape (tolerancia cca 2-3 znaky podæa dÂûky mena)
    function findSimilarName(name, map) {
        const keys = Array.from(map.keys());
        const cleanName = name.toLowerCase().trim();
        
        for (let key of keys) {
            const cleanKey = key.toLowerCase().trim();
            // Priama zhoda
            if (cleanKey === cleanName) return key;

            // Fuzzy zhoda
            const dist = levenshtein(cleanName, cleanKey);
            const allowedErrors = cleanName.length > 6 ? 2 : 1; // Ak je meno dlhÈ, povolÌme 2 chyby
            
            if (dist <= allowedErrors) {
                return key; // Naöli sme existuj˙ce podobnÈ meno
            }
        }
        return null; // éiadna zhoda
    }

    async function startProcess() {
        const key = apiKeyInput.value.trim();
        const files = Array.from(fileInput.files);
        if (!key) return alert("Ch˝ba API kæ˙Ë!");
        if (files.length === 0) return alert("Vyberte s˙bory!");
        localStorage.setItem('groq_api_key', key);

        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        logDiv.innerHTML = "";
        
        // Hlavn· mapa d·t: Kæ˙Ë = Meno, Hodnota = Objekt so ötatistikami
        let masterMap = new Map();

        for (let i = 0; i < files.length; i++) {
            addLog(`Sprac˙vam fotku ${i+1}/${files.length}...`);
            try {
                const base64 = await toBase64(files[i]);
                const result = await callGroq(key, base64);
                
                if (result && result.players) {
                    addLog(`  -> Detekovan˝ typ: ${result.type || 'Nezn·my'} (${result.players.length} hr·Ëov)`);
                    
                    result.players.forEach(p => {
                        if (!p.name) return;
                        
                        // Rieöenie podobn˝ch mien
                        let targetName = p.name.trim();
                        const similar = findSimilarName(targetName, masterMap);
                        
                        if (similar) {
                            // Ak existuje podobnÈ meno, pouûijeme to existuj˙ce (zjednotenie)
                            // addLog(`  (Merge: "${targetName}" -> "${similar}")`);
                            targetName = similar;
                        }

                        // ZÌskame alebo vytvorÌme z·znam
                        if (!masterMap.has(targetName)) {
                            masterMap.set(targetName, defaultStats());
                        }
                        const currentStats = masterMap.get(targetName);

                        // Merge d·t - prepÌöeme len to, Ëo nie je null/0 v novom objekte
                        // API vracia len tie polia, ktorÈ naölo, takûe ich zl˙Ëime
                        Object.keys(p).forEach(k => {
                            if (k !== 'name' && p[k] !== undefined && p[k] !== null && p[k] !== '') {
                                // Preferujeme existuj˙cu hodnotu ak nov· je 0, inak prepÌöeme
                                // Ale tu ide o dopÂÚanie z rÙznych tabuliek, takûe len priradÌme
                                currentStats[k] = p[k];
                            }
                        });
                    });
                } else {
                    addLog(`  -> éiadne d·ta nen·jdenÈ.`);
                }
                
                // Pauza kvÙli rate limitom (pri 100 fotk·ch dÙleûitÈ)
                await new Promise(r => setTimeout(r, 2500)); 

            } catch (e) {
                addLog(`Chyba pri s˙bore ${files[i].name}: ${e.message}`);
            }
        }

        if (masterMap.size > 0) {
            const fileName = prompt("Spracovanie hotovÈ! Zadajte n·zov s˙boru pre uloûenie:", "golf_stats_komplet");
            if (fileName) downloadResults(masterMap, fileName);
        } else {
            addLog("Nepodarilo sa extrahovaù ûiadne d·ta.");
        }
        btn.disabled = false;
    }

    async function callGroq(key, base64) {
        // Tento prompt je kritick˝ pre spr·vne rozlÌöenie tabuliek
        const promptText = `
        Analyze this golf leaderboard image. It is one of three specific types. Identify the type and extract data for every player found.
        
        TYPE 1: "Drive Distance"
        - Columns usually: Pos, Player, Avg Drive Distance, Longest Drive, FIR%.
        - If found, extract ONLY: "name" and "longest_drive" (the middle number, e.g., 331).

        TYPE 2: "Scoring Averages"
        - Columns usually: Pos, Player, Score Avg, Par 3, Par 4, Par 5.
        - If found, extract: "name", "score_avg", "par_3", "par_4", "par_5".

        TYPE 3: "Scoring Totals"
        - Columns usually: Aces, D Eagles, Eagles, Birdies, Pars, Bogeys, D Bogeys.
        - If found, extract: "name", "aces", "d_eagles", "eagles", "birdies", "pars", "bogeys", "d_bogeys".

        Rules:
        1. Extract numbers exactly as shown (integers or decimals).
        2. If a value is missing or empty, use 0.
        3. Return JSON format: { "type": "drive" | "averages" | "totals", "players": [ { "name": "Name", ...stats } ] }
        4. Do NOT include fields that are not in the image.
        `;

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "meta-llama/llama-3.2-90b-vision-preview", // Vision model pre lepöie ËÌtanie
                messages: [{
                    role: "user",
                    content: [
                        { type: "text", text: promptText },
                        { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                    ]
                }],
                temperature: 0,
                response_format: { type: "json_object" }
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error?.message || "API Error");
        }

        const json = await response.json();
        return JSON.parse(json.choices[0].message.content);
    }

    function toBase64(file) {
        return new Promise(r => {
            const rd = new FileReader();
            rd.readAsDataURL(file);
            rd.onload = () => r(rd.result.split(',')[1]);
        });
    }

    function downloadResults(map, filename) {
        // Zoradenie (voliteænÈ, teraz podæa abecedy, d· sa zmeniù)
        const sorted = Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0]));

        let output = "";
        
        // Helper na form·tovanie (ak je to ËÌslo, nech·me tak, ak undefined, d·me 0)
        const fmt = (val) => (val === undefined || val === null || val === "") ? "0" : String(val);

        sorted.forEach(([name, stats]) => {
            output += `${name}\n`;
            // Poradie presne podæa zadania:
            output += `${fmt(stats.longest_drive)}\n`; // 1. Longest Drive
            output += `${fmt(stats.score_avg)}\n`;     // 2. Score Avg
            output += `${fmt(stats.par_3)}\n`;         // 3. Par 3
            output += `${fmt(stats.par_4)}\n`;         // 4. Par 4
            output += `${fmt(stats.par_5)}\n`;         // 5. Par 5
            output += `${fmt(stats.aces)}\n`;          // 6. Aces
            output += `${fmt(stats.d_eagles)}\n`;      // 7. D Eagles
            output += `${fmt(stats.eagles)}\n`;        // 8. Eagles
            output += `${fmt(stats.birdies)}\n`;       // 9. Birdies
            output += `${fmt(stats.pars)}\n`;          // 10. Pars
            output += `${fmt(stats.bogeys)}\n`;        // 11. Bogeys
            output += `${fmt(stats.d_bogeys)}\n`;      // 12. D Bogeys
        });

        const blob = new Blob([output], {type: "text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${filename}.txt`;
        a.click();
        addLog("S˙bor bol ˙speöne stiahnut˝!");
    }
</script>
</body>
</html>
